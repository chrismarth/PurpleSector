"use strict";(self.webpackChunkpurple_sector=self.webpackChunkpurple_sector||[]).push([[412],{5973:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>t,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"notes/overview","title":"Design Notes","description":"Historical notes, migration guides, and architectural decisions for Purple Sector.","source":"@site/docs/notes/overview.md","sourceDirName":"notes","slug":"/notes/overview","permalink":"/PurpleSector/notes/overview","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"userGuide","previous":{"title":"Plot Layout System","permalink":"/PurpleSector/dev/plot-layouts"}}');var l=i(4848),r=i(8453);const t={},o="Design Notes",c={},d=[{value:"Plugin System Evolution",id:"plugin-system-evolution",level:2},{value:"Key Decision: <code>PluginClientContext</code> vs <code>PluginContext</code>",id:"key-decision-pluginclientcontext-vs-plugincontext",level:3},{value:"Key Decision: Plugin Schema Merging",id:"key-decision-plugin-schema-merging",level:3},{value:"Analysis Panel Toolbar Refactoring",id:"analysis-panel-toolbar-refactoring",level:2},{value:"Panel Actions Persistence Fix",id:"panel-actions-persistence-fix",level:3},{value:"Fullscreen Plot Sizing",id:"fullscreen-plot-sizing",level:2},{value:"Authentication",id:"authentication",level:2},{value:"Initial Load Resilience",id:"initial-load-resilience",level:2},{value:"Protobuf Migration",id:"protobuf-migration",level:2},{value:"uPlot Chart Library",id:"uplot-chart-library",level:2}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"design-notes",children:"Design Notes"})}),"\n",(0,l.jsx)(n.p,{children:"Historical notes, migration guides, and architectural decisions for Purple Sector."}),"\n",(0,l.jsx)(n.h2,{id:"plugin-system-evolution",children:"Plugin System Evolution"}),"\n",(0,l.jsx)(n.p,{children:"The plugin system evolved through several phases:"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Direct imports"})," \u2014 Features were hardcoded into the web app."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Lap analysis views"})," \u2014 First pluginized feature: telemetry plot panels registered via ",(0,l.jsx)(n.code,{children:"PluginContext.registerLapAnalysisView()"}),"."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Analysis panel grid"})," \u2014 Generalized to ",(0,l.jsx)(n.code,{children:"AnalysisPanelType"})," + ",(0,l.jsx)(n.code,{children:"AnalysisPanelProvider"})," with a configurable grid layout, fullscreen support, and synced hover."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"App shell plugins"})," \u2014 Extended to ",(0,l.jsx)(n.code,{children:"NavTabRegistration"}),", ",(0,l.jsx)(n.code,{children:"ContentTabRegistration"}),", ",(0,l.jsx)(n.code,{children:"ToolbarItemRegistration"})," for the IDE-style app shell."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Server-side plugins"})," \u2014 Added ",(0,l.jsx)(n.code,{children:"PluginServerContext"})," with ",(0,l.jsx)(n.code,{children:"registerApiRoute()"})," and ",(0,l.jsx)(n.code,{children:"registerAgentToolHandler()"})," for the agent plugin."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Client/server split"})," \u2014 Agent plugin uses separate entry points (",(0,l.jsx)(n.code,{children:"plugin.ts"})," / ",(0,l.jsx)(n.code,{children:"plugin.server.ts"}),") to avoid bundling Node.js modules in the client."]}),"\n"]}),"\n",(0,l.jsxs)(n.h3,{id:"key-decision-pluginclientcontext-vs-plugincontext",children:["Key Decision: ",(0,l.jsx)(n.code,{children:"PluginClientContext"})," vs ",(0,l.jsx)(n.code,{children:"PluginContext"})]}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"PluginContext"})," was renamed to ",(0,l.jsx)(n.code,{children:"PluginClientContext"})," when server-side registrations were added. The old name is kept as a deprecated type alias for backward compatibility."]}),"\n",(0,l.jsx)(n.h3,{id:"key-decision-plugin-schema-merging",children:"Key Decision: Plugin Schema Merging"}),"\n",(0,l.jsxs)(n.p,{children:["Rather than a single monolithic Prisma schema, plugins define their own models in ",(0,l.jsx)(n.code,{children:"plugin.prisma"})," files. A merge script combines them into a generated schema. This keeps plugin models co-located with their code while still producing a single Prisma client."]}),"\n",(0,l.jsx)(n.h2,{id:"analysis-panel-toolbar-refactoring",children:"Analysis Panel Toolbar Refactoring"}),"\n",(0,l.jsxs)(n.p,{children:["The panel toolbar was refactored to support a ",(0,l.jsx)(n.strong,{children:"host-rendered"})," model:"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Providers return ",(0,l.jsx)(n.code,{children:"AnalysisPanelRenderResult"})," with ",(0,l.jsx)(n.code,{children:"title"}),", ",(0,l.jsx)(n.code,{children:"toolbarActions"}),", and ",(0,l.jsx)(n.code,{children:"content"}),"."]}),"\n",(0,l.jsx)(n.li,{children:"The grid renders a unified toolbar with the provider's title and actions on the left, and host controls (fullscreen, layout actions) on the right."}),"\n",(0,l.jsx)(n.li,{children:"This replaced an earlier model where each provider rendered its own toolbar, which led to inconsistent styling and broken fullscreen buttons."}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"panel-actions-persistence-fix",children:"Panel Actions Persistence Fix"}),"\n",(0,l.jsxs)(n.p,{children:["The edit (pencil) button in the panel toolbar was broken because the plugin's ",(0,l.jsx)(n.code,{children:"render()"})," function created a local ",(0,l.jsx)(n.code,{children:"let actions = null"})," on every call. ",(0,l.jsx)(n.code,{children:"SimpleTelemetryPlotPanel"})," registered actions via ",(0,l.jsx)(n.code,{children:"onRegisterActions"})," only once on mount, but subsequent ",(0,l.jsx)(n.code,{children:"render()"})," calls created new null variables. Fixed by using a persistent ",(0,l.jsx)(n.code,{children:"panelActionsMap"})," (",(0,l.jsx)(n.code,{children:"Map<string, PanelActions>"}),") outside ",(0,l.jsx)(n.code,{children:"render()"}),", keyed by ",(0,l.jsx)(n.code,{children:"panelId"}),"."]}),"\n",(0,l.jsx)(n.h2,{id:"fullscreen-plot-sizing",children:"Fullscreen Plot Sizing"}),"\n",(0,l.jsxs)(n.p,{children:["Fullscreen telemetry plots initially showed a blank box because ",(0,l.jsx)(n.code,{children:"ConfigurableTelemetryChart"})," used a fixed 250px height. The fix involved:"]}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"AnalysisPanelGrid"})," measures the fullscreen content area via ",(0,l.jsx)(n.code,{children:"ResizeObserver"}),"."]}),"\n",(0,l.jsxs)(n.li,{children:["The measured height (minus ~130px for toolbar + chart chrome) is passed as ",(0,l.jsx)(n.code,{children:"host.availableHeight"}),"."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"SimpleTelemetryPlotPanel"})," passes this height to ",(0,l.jsx)(n.code,{children:"ConfigurableTelemetryChart"}),"."]}),"\n",(0,l.jsx)(n.li,{children:"The chart uses the provided height instead of the fixed default."}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["A CSS-only auto-sizing approach was attempted first but caused layout instability due to circular dependencies between flex containers and the chart's ",(0,l.jsx)(n.code,{children:"ResizeObserver"}),"."]}),"\n",(0,l.jsx)(n.h2,{id:"authentication",children:"Authentication"}),"\n",(0,l.jsxs)(n.p,{children:["The current auth system is a ",(0,l.jsx)(n.strong,{children:"stub"})," for development:"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Cookie-based: the ",(0,l.jsx)(n.code,{children:"ps_user"})," cookie contains the username string (",(0,l.jsx)(n.code,{children:"admin"})," or ",(0,l.jsx)(n.code,{children:"user"}),")."]}),"\n",(0,l.jsx)(n.li,{children:"Middleware checks the cookie on every non-public request."}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"AuthProvider"})," fetches ",(0,l.jsx)(n.code,{children:"/api/auth/me"})," on mount with timeout and retry logic."]}),"\n",(0,l.jsxs)(n.li,{children:["Two hardcoded users with different roles (",(0,l.jsx)(n.code,{children:"ORG_ADMIN"}),", ",(0,l.jsx)(n.code,{children:"USER"}),")."]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"This will be replaced with a proper authentication provider (OAuth, JWT, etc.) for production."}),"\n",(0,l.jsx)(n.h2,{id:"initial-load-resilience",children:"Initial Load Resilience"}),"\n",(0,l.jsx)(n.p,{children:"The initial app load could hang intermittently in dev mode due to:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Next.js on-demand compilation of API routes queuing up when multiple fetches fire simultaneously."}),"\n",(0,l.jsx)(n.li,{children:"Google Font download blocking SSR if the CDN is slow."}),"\n",(0,l.jsxs)(n.li,{children:["No timeout on ",(0,l.jsx)(n.code,{children:"fetch()"})," calls in ",(0,l.jsx)(n.code,{children:"AuthProvider"})," and ",(0,l.jsx)(n.code,{children:"NavContext"}),"."]}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Fixes applied:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"AuthProvider"}),": 5-second timeout + 3 retries with backoff on ",(0,l.jsx)(n.code,{children:"/api/auth/me"}),"."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"NavContext"}),": 8-second timeout on ",(0,l.jsx)(n.code,{children:"/api/events"})," fetch."]}),"\n",(0,l.jsxs)(n.li,{children:["Google Font: ",(0,l.jsx)(n.code,{children:'display: "swap"'})," to prevent render blocking."]}),"\n",(0,l.jsxs)(n.li,{children:["Root ",(0,l.jsx)(n.code,{children:"loading.tsx"})," for Next.js Suspense boundary."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"optimizePackageImports"})," in ",(0,l.jsx)(n.code,{children:"next.config.mjs"})," for faster dev compilation."]}),"\n",(0,l.jsxs)(n.li,{children:["Removed hidden rendering of ",(0,l.jsx)(n.code,{children:"page.tsx"})," children inside ",(0,l.jsx)(n.code,{children:"AppShellRoot"})," to eliminate duplicate fetches."]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"protobuf-migration",children:"Protobuf Migration"}),"\n",(0,l.jsx)(n.p,{children:"Telemetry transport was migrated from JSON to Protocol Buffers for efficiency:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["Schema: ",(0,l.jsx)(n.code,{children:"packages/proto/telemetry.proto"})]}),"\n",(0,l.jsxs)(n.li,{children:["Encoding: Collectors serialize ",(0,l.jsx)(n.code,{children:"TelemetryFrame"})," as Protobuf before publishing to Kafka."]}),"\n",(0,l.jsx)(n.li,{children:"Decoding: The WS bridge and frontend decode Protobuf back to objects."}),"\n",(0,l.jsx)(n.li,{children:"Compression: LZ4 compression on Kafka messages."}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"uplot-chart-library",children:"uPlot Chart Library"}),"\n",(0,l.jsxs)(n.p,{children:["Charts use ",(0,l.jsx)(n.a,{href:"https://github.com/leeoniya/uPlot",children:"uPlot"})," for high-performance time-series rendering:"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Lightweight (~35KB) compared to alternatives."}),"\n",(0,l.jsx)(n.li,{children:"Handles large datasets (tens of thousands of points) without lag."}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"ConfigurableTelemetryChart"})," wraps uPlot with React lifecycle management."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"ResizeObserver"})," tracks container width; height is controlled via props."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(a,{...e})}):a(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>t,x:()=>o});var s=i(6540);const l={},r=s.createContext(l);function t(e){const n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:t(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);