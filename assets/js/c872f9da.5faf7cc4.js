"use strict";(self.webpackChunkpurple_sector=self.webpackChunkpurple_sector||[]).push([[19],{8453:(e,n,i)=>{i.d(n,{R:()=>l,x:()=>a});var s=i(6540);const t={},r=s.createContext(t);function l(e){const n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),s.createElement(r.Provider,{value:n},e.children)}},8458:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>p,frontMatter:()=>l,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"dev/plugins","title":"Plugin Architecture","description":"This document describes the Purple Sector plugin architecture \u2014 the type system, registration API, client/server split, and how to write a new plugin.","source":"@site/docs/dev/plugins.md","sourceDirName":"dev","slug":"/dev/plugins","permalink":"/PurpleSector/dev/plugins","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"plugins","title":"Plugin Architecture","sidebar_label":"Plugins"},"sidebar":"userGuide","previous":{"title":"App Shell Architecture","permalink":"/PurpleSector/dev/app-shell"},"next":{"title":"Analysis Panels","permalink":"/PurpleSector/dev/analysis-panels"}}');var t=i(4848),r=i(8453);const l={id:"plugins",title:"Plugin Architecture",sidebar_label:"Plugins"},a=void 0,d={},o=[{value:"Overview",id:"overview",level:2},{value:"Plugin API Package",id:"plugin-api-package",level:2},{value:"PluginManifest",id:"pluginmanifest",level:3},{value:"PluginModule",id:"pluginmodule",level:3},{value:"PluginClientContext",id:"pluginclientcontext",level:3},{value:"PluginServerContext",id:"pluginservercontext",level:3},{value:"Registration Types Reference",id:"registration-types-reference",level:2},{value:"Analysis Panels",id:"analysis-panels",level:3},{value:"Navigation Tabs",id:"navigation-tabs",level:3},{value:"Content Tabs",id:"content-tabs",level:3},{value:"Toolbar Items",id:"toolbar-items",level:3},{value:"Global Panels",id:"global-panels",level:3},{value:"Settings Tabs",id:"settings-tabs",level:3},{value:"Agent Tools",id:"agent-tools",level:3},{value:"Plugin Registry",id:"plugin-registry",level:2},{value:"Client/Server Split",id:"clientserver-split",level:2},{value:"API Route Dispatcher",id:"api-route-dispatcher",level:2},{value:"Plugin Database Models",id:"plugin-database-models",level:2},{value:"Writing a New Plugin",id:"writing-a-new-plugin",level:2},{value:"1. Create the Package",id:"1-create-the-package",level:3},{value:"2. Define the Manifest",id:"2-define-the-manifest",level:3},{value:"3. Implement Registrations",id:"3-implement-registrations",level:3},{value:"4. Wire Into the App",id:"4-wire-into-the-app",level:3},{value:"5. (Optional) Add Database Models",id:"5-optional-add-database-models",level:3},{value:"6. Test",id:"6-test",level:3}];function c(e){const n={code:"code",h2:"h2",h3:"h3",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:"This document describes the Purple Sector plugin architecture \u2014 the type system, registration API, client/server split, and how to write a new plugin."}),"\n",(0,t.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Plugins"})," are TypeScript/React packages that implement interfaces from ",(0,t.jsx)(n.code,{children:"@purplesector/plugin-api"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["The ",(0,t.jsx)(n.strong,{children:"plugin registry"})," (",(0,t.jsx)(n.code,{children:"@purplesector/plugin-registry"}),") loads and indexes all registrations at startup."]}),"\n",(0,t.jsx)(n.li,{children:"Plugins can provide: analysis panel types, nav tabs, content tabs, toolbar items, global panels, settings tabs, agent tools, and API routes."}),"\n",(0,t.jsxs)(n.li,{children:["Each plugin declares a ",(0,t.jsx)(n.strong,{children:"manifest"})," with an ID, name, version, capabilities, and optional tier (",(0,t.jsx)(n.code,{children:"free"})," / ",(0,t.jsx)(n.code,{children:"premium"}),")."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"plugin-api-package",children:"Plugin API Package"}),"\n",(0,t.jsxs)(n.p,{children:["All shared types live in ",(0,t.jsx)(n.code,{children:"packages/plugin-api"})," (",(0,t.jsx)(n.code,{children:"@purplesector/plugin-api"}),"). Key exports:"]}),"\n",(0,t.jsx)(n.h3,{id:"pluginmanifest",children:"PluginManifest"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"type PluginCapability =\n  | 'lapAnalysisView'\n  | 'analysisPanels'\n  | 'agentTools'\n  | 'apiRoutes'\n  | 'settingsTabs'\n  | 'globalUI'\n  | 'navTab'\n  | 'contentTab'\n  | 'toolbarItem';\n\ninterface PluginManifest {\n  id: string;                    // e.g. 'purple-sector.core-lap-views'\n  name: string;\n  version: string;\n  description?: string;\n  capabilities: PluginCapability[];\n  entry: string;\n  tier?: 'free' | 'premium';\n  prismaModels?: string;         // Path to plugin.prisma if the plugin has DB models\n  dependencies?: string[];       // Other plugin IDs this plugin depends on\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"pluginmodule",children:"PluginModule"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"interface PluginModule {\n  manifest: PluginManifest;\n  register?: (ctx: PluginClientContext) => void;       // Client-side registrations\n  registerServer?: (ctx: PluginServerContext) => void;  // Server-side registrations\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"pluginclientcontext",children:"PluginClientContext"}),"\n",(0,t.jsx)(n.p,{children:"The client registration context provides methods for each extension point:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"interface PluginClientContext {\n  // Lap analysis views (legacy)\n  registerLapAnalysisView(view: LapAnalysisView): void;\n\n  // Analysis panel system\n  registerAnalysisPanelType(type: AnalysisPanelType): void;\n  registerAnalysisPanelProvider(provider: AnalysisPanelProvider): void;\n\n  // App shell extensions\n  registerNavTab(tab: NavTabRegistration): void;\n  registerContentTab(tab: ContentTabRegistration): void;\n  registerToolbarItem(item: ToolbarItemRegistration): void;\n\n  // Global UI\n  registerGlobalPanel(panel: GlobalPanelRegistration): void;\n  registerSettingsTab(tab: SettingsTabRegistration): void;\n\n  // Agent tools (client-side metadata only)\n  registerAgentTool(tool: AgentToolDefinition): void;\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"pluginservercontext",children:"PluginServerContext"}),"\n",(0,t.jsx)(n.p,{children:"The server registration context handles API routes and agent tool handlers:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"interface PluginServerContext {\n  registerApiRoute(route: PluginApiRoute): void;\n  registerAgentToolHandler(handler: AgentToolHandler): void;\n}\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"registration-types-reference",children:"Registration Types Reference"}),"\n",(0,t.jsx)(n.h3,{id:"analysis-panels",children:"Analysis Panels"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"interface AnalysisPanelType {\n  id: string;      // e.g. 'plot', 'track-map'\n  label: string;   // Human-friendly name\n}\n\ninterface AnalysisPanelProvider {\n  id: string;\n  typeId: string;              // References AnalysisPanelType.id\n  isDefault?: boolean;\n  render: (props: AnalysisPanelProps) => AnalysisPanelRender;\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"AnalysisPanelProps"})," includes telemetry data, compare data, host API (with ",(0,t.jsx)(n.code,{children:"setTitle"}),", ",(0,t.jsx)(n.code,{children:"availableHeight"}),"), panel state, synced hover value, and math channels."]}),"\n",(0,t.jsxs)(n.p,{children:["Providers can return either a plain ",(0,t.jsx)(n.code,{children:"React.ReactElement"})," or a structured ",(0,t.jsx)(n.code,{children:"AnalysisPanelRenderResult"})," with ",(0,t.jsx)(n.code,{children:"title"}),", ",(0,t.jsx)(n.code,{children:"toolbarActions"}),", and ",(0,t.jsx)(n.code,{children:"content"})," for host-rendered toolbars."]}),"\n",(0,t.jsx)(n.h3,{id:"navigation-tabs",children:"Navigation Tabs"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"interface NavTabRegistration {\n  id: string;\n  label: string;\n  icon: React.ComponentType<{ className?: string }>;\n  order: number;\n  disabled?: boolean;\n  renderTree: (ctx: NavTreeContext) => React.ReactElement;\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"content-tabs",children:"Content Tabs"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"interface ContentTabRegistration {\n  type: string;    // Matches TabDescriptor.type\n  render: (props: {\n    entityId?: string;\n    parentIds?: Record<string, string>;\n  }) => React.ReactElement;\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"toolbar-items",children:"Toolbar Items"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"interface ToolbarItemRegistration {\n  id: string;\n  icon: React.ComponentType<{ className?: string }>;\n  label: string;\n  position: 'top' | 'bottom';\n  order: number;\n  onClick?: (ctx: { openTab: (tab: TabDescriptor) => void }) => void;\n  renderPanel?: () => React.ReactElement;\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"global-panels",children:"Global Panels"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"interface GlobalPanelRegistration {\n  id: string;\n  position: 'sidebar-right' | 'sidebar-left' | 'drawer-bottom';\n  icon: React.ComponentType<{ className?: string }>;\n  label: string;\n  render: () => React.ReactElement;\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"settings-tabs",children:"Settings Tabs"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"interface SettingsTabRegistration {\n  id: string;\n  label: string;\n  icon: React.ComponentType<{ className?: string }>;\n  order?: number;\n  render: () => React.ReactElement;\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"agent-tools",children:"Agent Tools"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"interface AgentToolDefinition {\n  name: string;\n  description: string;\n  category: string;\n  parameters: Record<string, unknown>;  // JSON Schema\n}\n\ninterface AgentToolHandler {\n  name: string;\n  handler: (params: unknown, ctx: PluginRequestContext) => Promise<unknown>;\n}\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"plugin-registry",children:"Plugin Registry"}),"\n",(0,t.jsxs)(n.p,{children:["The registry (",(0,t.jsx)(n.code,{children:"packages/plugin-registry"}),") manages all registrations:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"plugins.config.ts"})})," \u2014 Lists enabled plugin manifest IDs. Remove an ID to disable a plugin."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"loadClientPlugins(modules)"})})," \u2014 Called at app startup. Iterates modules, checks if enabled, calls ",(0,t.jsx)(n.code,{children:"register()"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:(0,t.jsx)(n.code,{children:"loadServerPlugins(modules)"})})," \u2014 Called server-side. Calls ",(0,t.jsx)(n.code,{children:"registerServer()"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Accessor functions"})," \u2014 ",(0,t.jsx)(n.code,{children:"getNavTabs()"}),", ",(0,t.jsx)(n.code,{children:"getContentTabs()"}),", ",(0,t.jsx)(n.code,{children:"getAnalysisPanelProviders()"}),", ",(0,t.jsx)(n.code,{children:"getToolbarItems()"}),", ",(0,t.jsx)(n.code,{children:"getAgentToolDefinitions()"}),", etc."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"clientserver-split",children:"Client/Server Split"}),"\n",(0,t.jsx)(n.p,{children:"Some plugins have both client and server code. The agent plugin demonstrates the pattern:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Client entry"})," (",(0,t.jsx)(n.code,{children:"plugin.ts"}),") \u2014 Registers UI components, tool definitions (metadata only)."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Server entry"})," (",(0,t.jsx)(n.code,{children:"plugin.server.ts"}),") \u2014 Registers API routes, tool handlers (with Node.js dependencies)."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Subpath export"})," \u2014 ",(0,t.jsx)(n.code,{children:"@purplesector/plugin-agent/server"})," for the server entry."]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"This split prevents Node.js-only modules (LangGraph, Prisma) from being bundled into the client webpack."}),"\n",(0,t.jsxs)(n.p,{children:["The client loader (",(0,t.jsx)(n.code,{children:"apps/web/src/plugins/index.ts"}),") imports ",(0,t.jsx)(n.code,{children:"plugin.ts"}),". The server loader (",(0,t.jsx)(n.code,{children:"apps/web/src/lib/plugin-server.ts"}),") imports ",(0,t.jsx)(n.code,{children:"plugin.server.ts"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"api-route-dispatcher",children:"API Route Dispatcher"}),"\n",(0,t.jsx)(n.p,{children:"Plugin API routes are served by a catch-all Next.js route:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-text",children:"apps/web/src/app/api/plugins/[...path]/route.ts\n"})}),"\n",(0,t.jsxs)(n.p,{children:["It matches URLs like ",(0,t.jsx)(n.code,{children:"/api/plugins/<pluginId>/<path>"})," and dispatches to the registered ",(0,t.jsx)(n.code,{children:"PluginApiRoute"})," handler."]}),"\n",(0,t.jsx)(n.h2,{id:"plugin-database-models",children:"Plugin Database Models"}),"\n",(0,t.jsxs)(n.p,{children:["Plugins can define their own Prisma models in ",(0,t.jsx)(n.code,{children:"prisma/plugin.prisma"})," within their package directory. The merge script (",(0,t.jsx)(n.code,{children:"scripts/merge-plugin-schemas.ts"}),") scans all ",(0,t.jsx)(n.code,{children:"packages/plugin-*/prisma/plugin.prisma"})," files and produces ",(0,t.jsx)(n.code,{children:"packages/db-prisma/prisma/schema.generated.prisma"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"Run the merge after adding or modifying plugin schemas:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"npx ts-node scripts/merge-plugin-schemas.ts\nnpm run db:push\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"writing-a-new-plugin",children:"Writing a New Plugin"}),"\n",(0,t.jsx)(n.h3,{id:"1-create-the-package",children:"1. Create the Package"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"mkdir packages/plugin-my-feature\ncd packages/plugin-my-feature\nnpm init -y\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Set the package name to ",(0,t.jsx)(n.code,{children:"@purplesector/plugin-my-feature"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"2-define-the-manifest",children:"2. Define the Manifest"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"// src/plugin.tsx\nimport type { PluginModule, PluginManifest } from '@purplesector/plugin-api';\n\nconst manifest: PluginManifest = {\n  id: 'purple-sector.my-feature',\n  name: 'My Feature',\n  version: '0.1.0',\n  description: 'Adds my custom feature',\n  capabilities: ['contentTab', 'navTab'],\n  entry: './plugin',\n};\n"})}),"\n",(0,t.jsx)(n.h3,{id:"3-implement-registrations",children:"3. Implement Registrations"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"const plugin: PluginModule = {\n  manifest,\n  register(ctx) {\n    ctx.registerNavTab({ /* ... */ });\n    ctx.registerContentTab({ /* ... */ });\n  },\n};\n\nexport default plugin;\n"})}),"\n",(0,t.jsx)(n.h3,{id:"4-wire-into-the-app",children:"4. Wire Into the App"}),"\n",(0,t.jsxs)(n.p,{children:["Add the import to ",(0,t.jsx)(n.code,{children:"apps/web/src/plugins/index.ts"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"import myFeaturePlugin from '@purplesector/plugin-my-feature';\n\nconst allPlugins: PluginModule[] = [\n  coreLapViewsPlugin,\n  agentPlugin,\n  vehiclesPlugin,\n  myFeaturePlugin,  // \u2190 add here\n];\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Add the manifest ID to ",(0,t.jsx)(n.code,{children:"packages/plugin-registry/src/plugins.config.ts"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",children:"export const enabledPlugins = [\n  'purple-sector.core-lap-views',\n  'purple-sector.agent',\n  'purple-sector.vehicles',\n  'purple-sector.my-feature',  // \u2190 add here\n];\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Add path mappings to ",(0,t.jsx)(n.strong,{children:"both"})," ",(0,t.jsx)(n.code,{children:"tsconfig.json"})," (root) and ",(0,t.jsx)(n.code,{children:"apps/web/tsconfig.json"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"5-optional-add-database-models",children:"5. (Optional) Add Database Models"}),"\n",(0,t.jsxs)(n.p,{children:["Create ",(0,t.jsx)(n.code,{children:"packages/plugin-my-feature/prisma/plugin.prisma"})," with your models, then run the merge script."]}),"\n",(0,t.jsx)(n.h3,{id:"6-test",children:"6. Test"}),"\n",(0,t.jsx)(n.p,{children:"Start the dev server and verify your nav tab, content view, or other registrations appear in the UI."})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}}}]);