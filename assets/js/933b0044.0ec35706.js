"use strict";(self.webpackChunkpurple_sector=self.webpackChunkpurple_sector||[]).push([[240],{5220:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>p,frontMatter:()=>l,metadata:()=>r,toc:()=>a});const r=JSON.parse('{"id":"dev/monorepo-structure","title":"Monorepo Structure","description":"Purple Sector uses an Nx monorepo to organize the web app, desktop app, documentation site, collectors, services, and shared libraries.","source":"@site/docs/dev/monorepo-structure.md","sourceDirName":"dev","slug":"/dev/monorepo-structure","permalink":"/PurpleSector/dev/monorepo-structure","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"userGuide","previous":{"title":"Architecture","permalink":"/PurpleSector/dev/architecture"},"next":{"title":"Development Environment","permalink":"/PurpleSector/dev/dev-environment"}}');var i=s(4848),t=s(8453);const l={},c="Monorepo Structure",o={},a=[{value:"Repository Layout",id:"repository-layout",level:2},{value:"Key Directories",id:"key-directories",level:2},{value:"<code>apps/web/</code>",id:"appsweb",level:3},{value:"<code>packages/plugin-api/</code>",id:"packagesplugin-api",level:3},{value:"<code>packages/plugin-registry/</code>",id:"packagesplugin-registry",level:3},{value:"<code>packages/plugin-agent/</code>",id:"packagesplugin-agent",level:3},{value:"<code>packages/db-prisma/</code>",id:"packagesdb-prisma",level:3},{value:"Path Resolution",id:"path-resolution",level:2},{value:"Build and Dev Scripts",id:"build-and-dev-scripts",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"monorepo-structure",children:"Monorepo Structure"})}),"\n",(0,i.jsx)(n.p,{children:"Purple Sector uses an Nx monorepo to organize the web app, desktop app, documentation site, collectors, services, and shared libraries."}),"\n",(0,i.jsx)(n.h2,{id:"repository-layout",children:"Repository Layout"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-text",children:"PurpleSector/\n\u251c\u2500\u2500 apps/\n\u2502   \u251c\u2500\u2500 web/                          # Next.js app (frontend + API routes)\n\u2502   \u251c\u2500\u2500 desktop/                      # Tauri desktop app wrapping the web app\n\u2502   \u2502   \u2514\u2500\u2500 src-tauri/                # Tauri config & Rust side\n\u2502   \u251c\u2500\u2500 docs-site/                    # Docusaurus documentation site\n\u2502   \u251c\u2500\u2500 mcp-analysis/                 # MCP server for analysis tools\n\u2502   \u2514\u2500\u2500 mcp-telemetry/               # MCP server for telemetry tools\n\u2502\n\u251c\u2500\u2500 collectors/                       # Runtime collector apps (AC/ACC/demo, Kafka & WebSocket)\n\u2502\n\u251c\u2500\u2500 services/                         # Runtime infra services\n\u2502   \u251c\u2500\u2500 kafka-websocket-bridge.js     # Kafka \u2192 WebSocket bridge\n\u2502   \u251c\u2500\u2500 kafka-database-consumer.js    # Kafka \u2192 DB consumer\n\u2502   \u2514\u2500\u2500 ...                           # Legacy WebSocket server, etc.\n\u2502\n\u251c\u2500\u2500 packages/                         # Shared packages\n\u2502   \u251c\u2500\u2500 core/                         # @purplesector/core \u2014 domain types (TelemetryFrame, etc.)\n\u2502   \u251c\u2500\u2500 telemetry/                    # @purplesector/telemetry \u2014 parsing & helpers, MathTelemetryChannel\n\u2502   \u251c\u2500\u2500 config/                       # @purplesector/config \u2014 configuration utilities\n\u2502   \u251c\u2500\u2500 logger/                       # @purplesector/logger \u2014 structured logging\n\u2502   \u251c\u2500\u2500 kafka/                        # @purplesector/kafka \u2014 producer/admin/consumer\n\u2502   \u251c\u2500\u2500 proto/                        # @purplesector/proto \u2014 Protobuf helpers + telemetry.proto\n\u2502   \u251c\u2500\u2500 db-base/                      # @purplesector/db-base \u2014 DB interfaces\n\u2502   \u251c\u2500\u2500 db-prisma/                    # @purplesector/db-prisma \u2014 Prisma implementation + schema\n\u2502   \u251c\u2500\u2500 web-charts/                   # @purplesector/web-charts \u2014 chart components (uPlot)\n\u2502   \u2502                                 #   SimpleTelemetryPlotPanel, ConfigurableTelemetryChart\n\u2502   \u2502\n\u2502   \u251c\u2500\u2500 plugin-api/                   # @purplesector/plugin-api \u2014 plugin type definitions\n\u2502   \u2502                                 #   PluginManifest, PluginClientContext, PluginServerContext,\n\u2502   \u2502                                 #   AnalysisPanelProvider, GlobalPanelRegistration,\n\u2502   \u2502                                 #   NavTabRegistration, ContentTabRegistration, etc.\n\u2502   \u251c\u2500\u2500 plugin-registry/              # @purplesector/plugin-registry \u2014 central loader & accessors\n\u2502   \u2502                                 #   loadClientPlugins(), loadServerPlugins(), plugins.config.ts\n\u2502   \u251c\u2500\u2500 plugin-core-lap-telemetry/    # @purplesector/plugin-core-lap-telemetry \u2014 telemetry plot panels\n\u2502   \u251c\u2500\u2500 plugin-vehicles/              # @purplesector/plugin-vehicles \u2014 vehicle management UI\n\u2502   \u251c\u2500\u2500 plugin-agent/                 # @purplesector/plugin-agent \u2014 AI agent (premium tier)\n\u2502   \u2502                                 #   Split entry: plugin.ts (client), plugin.server.ts (server)\n\u2502   \u2502                                 #   Subpath export: @purplesector/plugin-agent/server\n\u2502   \u2502\n\u2502   \u251c\u2500\u2500 lap-analysis-base/            # @purplesector/lap-analysis-base \u2014 LapAnalyzer interface\n\u2502   \u251c\u2500\u2500 lap-analysis-simple/          # @purplesector/lap-analysis-simple \u2014 single-call analyzer\n\u2502   \u251c\u2500\u2500 lap-analysis-langgraph/       # @purplesector/lap-analysis-langgraph \u2014 agentic DAG analyzer\n\u2502   \u2514\u2500\u2500 lap-analysis-factory/         # @purplesector/lap-analysis-factory \u2014 createAnalyzer() factory\n\u2502\n\u251c\u2500\u2500 scripts/                          # Operational scripts\n\u2502   \u251c\u2500\u2500 dev-start.sh / dev-stop.sh    # One-command dev environment\n\u2502   \u251c\u2500\u2500 merge-plugin-schemas.ts       # Merges plugin.prisma files into generated schema\n\u2502   \u2514\u2500\u2500 ...                           # Kafka setup, topic creation, etc.\n\u2502\n\u251c\u2500\u2500 docker-compose.kafka.yml          # Kafka cluster for dev\n\u251c\u2500\u2500 ecosystem.config.js               # PM2 config (production)\n\u251c\u2500\u2500 ecosystem.dev.config.js           # PM2 config (development)\n\u251c\u2500\u2500 next.config.mjs                   # Next.js configuration\n\u251c\u2500\u2500 nx.json                           # Nx workspace configuration\n\u251c\u2500\u2500 package.json                      # Root package.json with scripts\n\u2514\u2500\u2500 tsconfig.json                     # Root TypeScript configuration\n"})}),"\n",(0,i.jsx)(n.h2,{id:"key-directories",children:"Key Directories"}),"\n",(0,i.jsx)(n.h3,{id:"appsweb",children:(0,i.jsx)(n.code,{children:"apps/web/"})}),"\n",(0,i.jsx)(n.p,{children:"The Next.js application \u2014 both the React frontend and the API routes. Key subdirectories:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"src/app/"})," \u2014 Next.js App Router pages and API routes."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"src/components/app-shell/"})," \u2014 App shell components (AppShell, NavPane, ContentPane, ToolbarPane, etc.)."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"src/components/"})," \u2014 Shared UI components (AuthProvider, AnalysisPanelGrid, dialogs, etc.)."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"src/plugins/index.ts"})," \u2014 Client-side plugin loader."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"src/lib/"})," \u2014 Server utilities (auth, plugin-server loader, API auth helpers)."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"packagesplugin-api",children:(0,i.jsx)(n.code,{children:"packages/plugin-api/"})}),"\n",(0,i.jsx)(n.p,{children:"Defines all the TypeScript interfaces that plugins implement:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"plugin.ts"})," \u2014 ",(0,i.jsx)(n.code,{children:"PluginModule"}),", ",(0,i.jsx)(n.code,{children:"PluginClientContext"}),", ",(0,i.jsx)(n.code,{children:"PluginServerContext"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"types.ts"})," \u2014 ",(0,i.jsx)(n.code,{children:"PluginManifest"}),", ",(0,i.jsx)(n.code,{children:"PluginCapability"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"analysisPanels.ts"})," \u2014 ",(0,i.jsx)(n.code,{children:"AnalysisPanelType"}),", ",(0,i.jsx)(n.code,{children:"AnalysisPanelProvider"}),", ",(0,i.jsx)(n.code,{children:"AnalysisPanelProps"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"globalUI.ts"})," \u2014 ",(0,i.jsx)(n.code,{children:"NavTabRegistration"}),", ",(0,i.jsx)(n.code,{children:"ContentTabRegistration"}),", ",(0,i.jsx)(n.code,{children:"ToolbarItemRegistration"}),", ",(0,i.jsx)(n.code,{children:"TabDescriptor"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"agentTools.ts"})," \u2014 ",(0,i.jsx)(n.code,{children:"AgentToolDefinition"}),", ",(0,i.jsx)(n.code,{children:"AgentToolHandler"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"serverPlugin.ts"})," \u2014 ",(0,i.jsx)(n.code,{children:"PluginServerContext"}),", ",(0,i.jsx)(n.code,{children:"PluginApiRoute"})]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"packagesplugin-registry",children:(0,i.jsx)(n.code,{children:"packages/plugin-registry/"})}),"\n",(0,i.jsx)(n.p,{children:"Central plugin loader. Key files:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"src/plugins.config.ts"})," \u2014 Lists enabled plugin manifest IDs."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"src/loader.ts"})," \u2014 ",(0,i.jsx)(n.code,{children:"loadClientPlugins()"}),", ",(0,i.jsx)(n.code,{children:"loadServerPlugins()"}),", and all accessor functions."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"packagesplugin-agent",children:(0,i.jsx)(n.code,{children:"packages/plugin-agent/"})}),"\n",(0,i.jsx)(n.p,{children:"The AI agent plugin. Has split entry points to avoid bundling Node.js-only dependencies in the client bundle:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"src/plugin.ts"})," \u2014 Client registrations (chat panel, toolbar item, settings tab, tool definitions)."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"src/plugin.server.ts"})," \u2014 Server registrations (API routes, tool handlers)."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"src/shared/tool-definitions.ts"})," \u2014 Client-safe tool metadata."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"prisma/plugin.prisma"})," \u2014 Agent-specific database models."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"packagesdb-prisma",children:(0,i.jsx)(n.code,{children:"packages/db-prisma/"})}),"\n",(0,i.jsx)(n.p,{children:"Prisma ORM implementation. The schema is composed of:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"prisma/schema.prisma"})," \u2014 Core models (Event, Session, Lap, TelemetryFrame, Vehicle, etc.)."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"prisma/schema.generated.prisma"})," \u2014 Auto-generated from plugin schemas (gitignored)."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The merge script (",(0,i.jsx)(n.code,{children:"scripts/merge-plugin-schemas.ts"}),") scans ",(0,i.jsx)(n.code,{children:"packages/plugin-*/prisma/plugin.prisma"})," and produces the generated file."]}),"\n",(0,i.jsx)(n.h2,{id:"path-resolution",children:"Path Resolution"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"apps/web/tsconfig.json"})," has its own ",(0,i.jsx)(n.code,{children:"paths"})," that override the root ",(0,i.jsx)(n.code,{children:"tsconfig.json"}),". When adding a new package, you ",(0,i.jsx)(n.strong,{children:"must"})," add path mappings to ",(0,i.jsx)(n.strong,{children:"both"})," tsconfig files."]}),"\n",(0,i.jsx)(n.h2,{id:"build-and-dev-scripts",children:"Build and Dev Scripts"}),"\n",(0,i.jsxs)(n.p,{children:["Key npm scripts from ",(0,i.jsx)(n.code,{children:"package.json"}),":"]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Script"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"npm run dev"})}),(0,i.jsx)(n.td,{children:"Start Next.js dev server only"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"npm run dev:start"})}),(0,i.jsx)(n.td,{children:"Start full Kafka pipeline + dev server"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"npm run dev:stop"})}),(0,i.jsx)(n.td,{children:"Stop services, keep Kafka running"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"npm run dev:stop-all"})}),(0,i.jsx)(n.td,{children:"Stop everything including Kafka"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"npm run db:push"})}),(0,i.jsx)(n.td,{children:"Push Prisma schema to database"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"npm run db:reset"})}),(0,i.jsx)(n.td,{children:"Reset database (destructive)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"npm run db:studio"})}),(0,i.jsx)(n.td,{children:"Open Prisma Studio"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"npm run kafka:setup"})}),(0,i.jsx)(n.td,{children:"Create Kafka topics"})]})]})]})]})}function p(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>l,x:()=>c});var r=s(6540);const i={},t=r.createContext(i);function l(e){const n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);