"use strict";(self.webpackChunkpurple_sector=self.webpackChunkpurple_sector||[]).push([[844],{4647:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>r,toc:()=>o});const r=JSON.parse('{"id":"dev/architecture","title":"Architecture","description":"This page describes the high-level architecture of Purple Sector: how telemetry flows from the simulator to the browser and AI analysis, and how the Kafka-based pipeline is structured.","source":"@site/docs/dev/architecture.md","sourceDirName":"dev","slug":"/dev/architecture","permalink":"/PurpleSector/dev/architecture","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"userGuide","previous":{"title":"Monitoring","permalink":"/PurpleSector/ops/monitoring"},"next":{"title":"Monorepo Structure","permalink":"/PurpleSector/dev/monorepo-structure"}}');var i=n(4848),t=n(8453);const l={},c="Architecture",a={},o=[{value:"System Overview",id:"system-overview",level:2},{value:"Kafka-Based Telemetry Architecture",id:"kafka-based-telemetry-architecture",level:2},{value:"Collectors",id:"collectors",level:3},{value:"Kafka Cluster",id:"kafka-cluster",level:3},{value:"Kafka\u2013WebSocket Bridge",id:"kafkawebsocket-bridge",level:3},{value:"Database Consumer",id:"database-consumer",level:3},{value:"Frontend and AI",id:"frontend-and-ai",level:3},{value:"User Isolation Architecture",id:"user-isolation-architecture",level:2}];function d(e){const s={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.header,{children:(0,i.jsx)(s.h1,{id:"architecture",children:"Architecture"})}),"\n",(0,i.jsx)(s.p,{children:"This page describes the high-level architecture of Purple Sector: how telemetry flows from the simulator to the browser and AI analysis, and how the Kafka-based pipeline is structured."}),"\n",(0,i.jsx)(s.h2,{id:"system-overview",children:"System Overview"}),"\n",(0,i.jsx)(s.p,{children:"At a high level:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-text",children:"[Assetto Corsa / ACC Telemetry]\n          \u2193\n[Telemetry Collector]\n          \u2193\n[Kafka] \u2192 [Kafka-WebSocket Bridge] \u2192 [WebSocket]\n          \u2193                          \u2193\n   [DB Consumer] \u2192 [PostgreSQL/TimescaleDB]\n          \u2193\n      [Next.js / React Frontend]\n          \u2193\n      [OpenAI GPT-4 Analysis]\n"})}),"\n",(0,i.jsx)(s.p,{children:"Key components:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Collectors"})," \u2013 Read telemetry from AC/ACC (UDP + shared memory) and publish to Kafka."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Kafka cluster"})," \u2013 Durable transport for telemetry and commands."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Kafka\u2013WebSocket bridge"})," \u2013 Consumes telemetry and exposes it over WebSockets to the frontend."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Database consumer"})," \u2013 Persists telemetry and lap data into PostgreSQL/TimescaleDB via Prisma."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Next.js app"})," \u2013 Frontend and API routes for managing sessions, laps, and AI analysis."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"AI analysis service"})," \u2013 Uses GPT-4 to generate coaching suggestions from telemetry."]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"kafka-based-telemetry-architecture",children:"Kafka-Based Telemetry Architecture"}),"\n",(0,i.jsx)(s.p,{children:"The Kafka-based pipeline provides:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Guaranteed delivery"})," and ",(0,i.jsx)(s.strong,{children:"durability"}),"."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Per-session ordering"})," via partitioning."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Horizontal scalability"})," across many concurrent sessions/users."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Efficient binary encoding"})," via Protobuf."]}),"\n"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-text",children:"Game Clients (AC/ACC)\n   \u2193\nCollectors (Producers) \u2500\u2500 Protobuf + LZ4 \u2500\u2500\u25b6 Kafka Topics\n   \u2193                                          (telemetry-user-*)\nKafka-WebSocket Bridge (Consumers) \u2500\u2500\u25b6 WebSocket Clients\n   \u2193\nDatabase Consumer \u2500\u2500\u25b6 TimescaleDB / PostgreSQL\n"})}),"\n",(0,i.jsx)(s.h3,{id:"collectors",children:"Collectors"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Live under ",(0,i.jsx)(s.code,{children:"collectors/"})," (Kafka and WebSocket variants)."]}),"\n",(0,i.jsxs)(s.li,{children:["Responsibilities:","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Parse game telemetry (UDP / shared memory)."}),"\n",(0,i.jsxs)(s.li,{children:["Map raw data into ",(0,i.jsx)(s.code,{children:"TelemetryFrame"})," structures."]}),"\n",(0,i.jsx)(s.li,{children:"Serialize frames using Protobuf."}),"\n",(0,i.jsx)(s.li,{children:"Publish to Kafka with appropriate keys for ordering."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h3,{id:"kafka-cluster",children:"Kafka Cluster"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Topics such as:","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"telemetry"})," \u2013 main telemetry stream."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"commands"})," \u2013 control commands."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"telemetry-user-<userId>"})," \u2013 per-user streams in the user isolation model."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.li,{children:"Tuned with compression (LZ4), retention, and replication appropriate to the environment (dev vs prod)."}),"\n"]}),"\n",(0,i.jsx)(s.h3,{id:"kafkawebsocket-bridge",children:"Kafka\u2013WebSocket Bridge"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["File: ",(0,i.jsx)(s.code,{children:"services/kafka-websocket-bridge.js"}),"."]}),"\n",(0,i.jsxs)(s.li,{children:["Responsibilities:","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Consume telemetry from Kafka."}),"\n",(0,i.jsx)(s.li,{children:"Maintain per-user or per-session consumers."}),"\n",(0,i.jsx)(s.li,{children:"Broadcast decoded Protobuf frames to connected WebSocket clients."}),"\n",(0,i.jsx)(s.li,{children:"Support demo playback."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h3,{id:"database-consumer",children:"Database Consumer"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["File: ",(0,i.jsx)(s.code,{children:"services/kafka-database-consumer.js"}),"."]}),"\n",(0,i.jsxs)(s.li,{children:["Responsibilities:","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Subscribe to user telemetry topics."}),"\n",(0,i.jsx)(s.li,{children:"Batch-insert telemetry frames for performance."}),"\n",(0,i.jsx)(s.li,{children:"Detect lap completions and persist laps."}),"\n",(0,i.jsx)(s.li,{children:"Maintain session metadata."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h3,{id:"frontend-and-ai",children:"Frontend and AI"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Next.js app (under ",(0,i.jsx)(s.code,{children:"apps/web"}),") connects to the WebSocket bridge and renders telemetry views."]}),"\n",(0,i.jsx)(s.li,{children:"API routes trigger AI analysis on laps using GPT-4 and return coaching suggestions to the UI."}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"user-isolation-architecture",children:"User Isolation Architecture"}),"\n",(0,i.jsxs)(s.p,{children:["Purple Sector implements ",(0,i.jsx)(s.strong,{children:"user-scoped Kafka topics"})," to ensure user data isolation (multi-tenancy):"]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:"Each user gets a dedicated topic:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-text",children:"telemetry-user-alice\ntelemetry-user-bob\ntelemetry-user-...\n"})}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:["Collectors publish to the user\x19s topic (e.g., ",(0,i.jsx)(s.code,{children:"telemetry-user-alice"}),")."]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsx)(s.p,{children:"The bridge creates a consumer per user and only forwards frames to WebSocket clients for that user."}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:["Frontend connections include ",(0,i.jsx)(s.code,{children:"userId"})," (or equivalent identity) so the bridge can wire the right consumer."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.p,{children:"This model provides:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Strong isolation"})," \u2013 User A\x19s data never appears on User B\x19s topic."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Scalability"})," \u2013 Kafka handles many topics; consumers are created/destroyed per active user."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Security"})," \u2013 In production, Kafka ACLs can restrict topic access by user and consumer group."]}),"\n"]}),"\n",(0,i.jsxs)(s.p,{children:["For the full rationale and implementation details, see the original ",(0,i.jsx)(s.code,{children:"docs/USER_ISOLATION_ARCHITECTURE.md"})," (being migrated into this section)."]})]})}function h(e={}){const{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,s,n)=>{n.d(s,{R:()=>l,x:()=>c});var r=n(6540);const i={},t=r.createContext(i);function l(e){const s=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),r.createElement(t.Provider,{value:s},e.children)}}}]);