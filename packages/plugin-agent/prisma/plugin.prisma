// Plugin: AI Agent
// Models for agent conversations, messages, and run plans.
// This file is merged with the base schema by scripts/merge-plugin-schemas.ts

model AgentConversation {
  id        String   @id @default(cuid())
  userId    String
  title     String?
  summary   String?
  context   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  AgentMessage[]

  @@index([userId, updatedAt])
}

model AgentMessage {
  id             String   @id @default(cuid())
  conversationId String
  role           String
  content        String
  toolCalls      String?
  toolResults    String?
  plan           String?
  createdAt      DateTime @default(now())

  conversation   AgentConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
}

model RunPlan {
  id          String   @id @default(cuid())
  userId      String
  eventId     String?
  name        String
  description String?
  status      String   @default("draft")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  event       Event?   @relation(fields: [eventId], references: [id], onDelete: SetNull)
  items       RunPlanItem[]

  @@index([userId])
  @@index([eventId])
}

model RunPlanItem {
  id                      String   @id @default(cuid())
  runPlanId               String
  order                   Int
  sessionName             String
  vehicleId               String?
  vehicleConfigurationId  String?
  vehicleSetupId          String?
  notes                   String?
  sessionId               String?  @unique
  status                  String   @default("planned")
  createdAt               DateTime @default(now())

  runPlan                 RunPlan              @relation(fields: [runPlanId], references: [id], onDelete: Cascade)
  vehicle                 Vehicle?             @relation(fields: [vehicleId], references: [id], onDelete: SetNull)
  vehicleConfiguration    VehicleConfiguration? @relation(fields: [vehicleConfigurationId], references: [id], onDelete: SetNull)
  vehicleSetup            VehicleSetup?        @relation(fields: [vehicleSetupId], references: [id], onDelete: SetNull)
  session                 Session?             @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@index([runPlanId, order])
}
